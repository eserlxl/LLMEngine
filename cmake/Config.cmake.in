# Copyright Â© 2025 Eser KUBALI <lxldev.contact@gmail.com>
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This file is part of LLMEngine and is licensed under
# the GNU General Public License v3.0 or later.
# See the LICENSE file in the project root for details.

@PACKAGE_INIT@

# Build-tree guard: if core target already exists (we're inside the source build),
# do not include exported targets to avoid partial redefinition. Let consumers
# use the already-defined build targets.
string(TOLOWER "@PROJECT_NAME@" _llm_ns)
if (TARGET ${_llm_ns}::${_llm_ns} OR TARGET @PROJECT_NAME@)
  # Skip dependency discovery and target imports in build-tree usage
  return()
endif()

# Verify required dependencies are available first
# Note: LLMEngine requires nlohmann_json and cpr. These must be provided by the consumer
# when using find_package(LLMEngine). If dependencies were fetched via FetchContent
# during LLMEngine's build, the Targets.cmake file may not exist, and consumers should
# link directly to the LLMEngine target or provide dependencies themselves.
include(CMakeFindDependencyMacro)
find_dependency(cpr REQUIRED)
find_dependency(nlohmann_json REQUIRED)

# Include the exported targets unless any of them already exist (build-tree usage)
# The exported namespace is lowercase with original target name (e.g., llmengine::LLMEngine)
# Note: Third-party dependencies (cpr, nlohmann_json) are not exported; consumers must provide them
set(_llm_targets
  ${_llm_ns}::@PROJECT_NAME@
  ${_llm_ns}::compile_options)

set(_need_include TRUE)
foreach(_t IN LISTS _llm_targets)
  if (TARGET ${_t})
    set(_need_include FALSE)
    break()
  endif()
endforeach()

if (_need_include)
  # Check if Targets.cmake exists (it may not if dependencies were fetched via FetchContent)
  if (EXISTS "${CMAKE_CURRENT_LIST_DIR}/@PROJECT_NAME@Targets.cmake")
    include("${CMAKE_CURRENT_LIST_DIR}/@PROJECT_NAME@Targets.cmake")
  else()
    # Targets.cmake not available - try to find build-tree targets or provide guidance
    # This happens when dependencies were fetched via FetchContent and export was skipped
    # Try to find the target in the build tree directly
    if (TARGET @PROJECT_NAME@)
      message(STATUS "LLMEngine: Using build-tree target directly (dependencies were fetched via FetchContent)")
    else
      # Provide helpful guidance instead of fatal error
      message(WARNING "LLMEngine Targets.cmake not found and build-tree targets not available. "
                      "This typically occurs when dependencies were fetched via FetchContent. "
                      "Options:\n"
                      "  1. Ensure dependencies (nlohmann_json, cpr) are available and link directly to the LLMEngine target\n"
                      "  2. Rebuild LLMEngine with system-provided dependencies (LLM_DISABLE_FETCHCONTENT=ON)\n"
                      "  3. Use FetchContent to include LLMEngine in your build tree\n"
                      "The package may still be usable if targets are defined elsewhere.")
    endif()
  endif()
endif()

# Verify the imported target exists
check_required_components(@PROJECT_NAME@)

# Ensure compile options interface target exists for consumers even when export set is absent
if (NOT TARGET ${_llm_ns}::compile_options)
  add_library(${_llm_ns}::compile_options INTERFACE IMPORTED)
endif()

