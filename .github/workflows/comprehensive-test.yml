# Copyright © 2025 Eser KUBALI <lxldev.contact@gmail.com>
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This file is part of LLMEngine and is licensed under
# the GNU General Public License v3.0 or later.
# See the LICENSE file in the project root for details.

name: Comprehensive Build Testing

permissions:
  contents: read
  actions: read

# Cancel older runs of the same ref to save CI minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'examples/**'
      - 'CMakeLists.txt'
      - '.github/workflows/comprehensive-test.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - 'examples/**'
      - 'CMakeLists.txt'
      - '.github/workflows/comprehensive-test.yml'

defaults:
  run:
    shell: bash

jobs:
  comprehensive-test:
    name: Build / Test (${{ matrix.compiler }} ${{ matrix.build_type }})
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]
        compiler: [gcc, clang]

    env:
      BUILD_DIR: build

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: build/
          key: ${{ runner.os }}-${{ matrix.build_type }}-${{ hashFiles('CMakeLists.txt', 'src/**') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.build_type }}-

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake make ccache python3 python3-pip libssl-dev libbrotli-dev libnghttp2-dev zlib1g-dev
          if [ "${{ matrix.compiler }}" = "gcc" ]; then sudo apt-get install -y g++; else sudo apt-get install -y clang; fi

      - name: Install meson
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install meson
          meson --version

      - name: Configure (${{ matrix.build_type }})
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then export CC=gcc; export CXX=g++; else export CC=clang; export CXX=clang++; fi
          # Remove CMakeCache.txt if it exists to ensure BUILD_TESTING is set correctly
          # The cache may restore a previous CMakeCache.txt with BUILD_TESTING=OFF
          rm -f "${BUILD_DIR}/CMakeCache.txt"
          cmake -S . -B "${BUILD_DIR}" -G "Unix Makefiles" -DCMAKE_BUILD_TYPE="${{ matrix.build_type }}" -DBUILD_TESTING=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build (make -j20)
        run: |
          cmake --build "${BUILD_DIR}" -- -j20
          # Explicitly build test targets (they're EXCLUDE_FROM_ALL by default)
          # Try to build build_all_tests target if it exists, otherwise build tests individually
          BUILD_ALL_TESTS_SUCCESS=false
          set +e
          cmake --build "${BUILD_DIR}" --target build_all_tests -j20 2>&1 | tee /tmp/build_all_tests.log
          BUILD_ALL_TESTS_EXIT_CODE=$?
          set -e
          if [ $BUILD_ALL_TESTS_EXIT_CODE -eq 0 ]; then
            echo "✓ Built all tests using build_all_tests target"
            BUILD_ALL_TESTS_SUCCESS=true
          else
            # Check if the error is "No rule to make target" (target doesn't exist)
            if grep -q "No rule to make target" /tmp/build_all_tests.log; then
              echo "⚠ build_all_tests target does not exist, building test targets individually"
            else
              echo "⚠ build_all_tests target failed (exit code: $BUILD_ALL_TESTS_EXIT_CODE), building test targets individually"
            fi
          fi
          
          # If build_all_tests didn't succeed, try building individual targets
          if [ "$BUILD_ALL_TESTS_SUCCESS" = "false" ]; then
            TEST_TARGETS=(
              test_llmengine
              test_api
              test_api_config_manager
              test_api_config_manager_thread_safety
              test_request_context_builder_thread_safety
              test_api_client_factory
              test_provider_type_mapping
              test_llmengine_construction
              test_integration
              test_api_config_parsing
              test_provider_mapping_extended
              test_tempdir_hardening
              test_request_logger
              test_retry_policy
              test_parameter_merger
              test_response_parser
              test_chat_completion_helper
              test_secret_redaction
              test_error_paths
            )
            BUILT_COUNT=0
            FAILED_COUNT=0
            SKIPPED_COUNT=0
            for target in "${TEST_TARGETS[@]}"; do
              set +e
              cmake --build "${BUILD_DIR}" --target "${target}" -j20 2>&1 | tee "/tmp/build_${target}.log"
              TARGET_EXIT_CODE=$?
              set -e
              if [ $TARGET_EXIT_CODE -eq 0 ]; then
                echo "✓ Built ${target}"
                BUILT_COUNT=$((BUILT_COUNT + 1))
              else
                if grep -q "No rule to make target" "/tmp/build_${target}.log"; then
                  echo "⚠ Target '${target}' does not exist, skipping"
                  SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                else
                  echo "✗ Failed to build ${target} (see /tmp/build_${target}.log for details)"
                  cat "/tmp/build_${target}.log"
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi
              fi
            done
            echo "Summary: Built ${BUILT_COUNT} test targets, ${FAILED_COUNT} failed, ${SKIPPED_COUNT} skipped"
            
            # If no targets were built and all were skipped, this is a configuration issue
            if [ $BUILT_COUNT -eq 0 ] && [ $SKIPPED_COUNT -eq ${#TEST_TARGETS[@]} ]; then
              echo "ERROR: No test targets were found. This indicates a configuration issue."
              echo "Checking if test directory was included..."
              if [ -d "${BUILD_DIR}/test" ]; then
                echo "Test directory exists in build tree"
                if [ -f "${BUILD_DIR}/test/CMakeFiles/CMakeDirectoryInformation.cmake" ]; then
                  echo "Test directory appears to be configured"
                else
                  echo "Test directory exists but may not be fully configured"
                fi
              else
                echo "Test directory does not exist in build tree - tests were not included"
              fi
              echo "Checking BUILD_TESTING setting..."
              grep "BUILD_TESTING" "${BUILD_DIR}/CMakeCache.txt" || echo "BUILD_TESTING not found in cache"
              exit 1
            fi
            
            # If some targets failed to build (not just missing), that's an error
            if [ $FAILED_COUNT -gt 0 ]; then
              echo "ERROR: ${FAILED_COUNT} test target(s) failed to build"
              exit 1
            fi
          fi

      - name: Run tests (ctest)
        run: |
          cd "${BUILD_DIR}"
          ctest --output-on-failure

      - name: Debug analysis (informational)
        run: |
          echo "=== Debug analysis (informational) ==="
          # Inspect a few binaries for debug symbols; do not fail the job
          set +e
          mapfile -t FILES < <(find "${BUILD_DIR}" -maxdepth 3 -type f -perm -111 | head -5)
          for f in "${FILES[@]}"; do
            if file "$f" | grep -q "ELF"; then
              echo "Inspecting: $f"
              file "$f"
              if file "$f" | grep -q "not stripped"; then
                echo "✓ $f has debug symbols (not stripped)"
              else
                echo "ℹ $f appears stripped"
              fi
            fi
          done
          set -e

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: build-logs-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: |
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
          if-no-files-found: ignore
          retention-days: 3