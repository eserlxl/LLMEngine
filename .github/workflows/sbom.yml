# Copyright Â© 2025 Eser KUBALI <lxldev.contact@gmail.com>
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This file is part of LLMEngine and is licensed under
# the GNU General Public License v3.0 or later.
# See the LICENSE file in the project root for details.

name: SBOM Generation

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  generate-sbom:
    name: Generate SBOM (CycloneDX)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      attestations: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CycloneDX
        run: |
          curl -sSL https://github.com/CycloneDX/cyclonedx-cli/releases/latest/download/cyclonedx-linux-x64 -o /tmp/cyclonedx
          chmod +x /tmp/cyclonedx
          sudo mv /tmp/cyclonedx /usr/local/bin/cyclonedx

      - name: Generate SBOM
        run: |
          # Create SBOM for dependencies
          cyclonedx bom \
            --input-format json \
            --output-format json \
            --output-file sbom-cyclonedx.json \
            --schema-version 1.5 \
            --component-type library \
            --name LLMEngine \
            --version "${{ github.ref_name }}" \
            --purl "pkg:github/eserlxl/LLMEngine@${{ github.ref_name }}" \
            || echo "Note: CycloneDX CLI may require dependency manifest files"

      - name: Generate dependency digest
        run: |
          # Create a simple dependency digest for verification
          {
            echo "# LLMEngine Dependency Digest"
            echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Commit: ${{ github.sha }}"
            echo ""
            echo "## CMake Dependencies"
            grep -E "find_package|FetchContent" CMakeLists.txt | head -20 || true
            echo ""
            echo "## External Dependencies"
            echo "- nlohmann_json (v3.11.3)"
            echo "- cpr (latest)"
            echo "- OpenSSL (system)"
          } > dependency-digest.txt

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: |
            sbom-cyclonedx.json
            dependency-digest.txt
          retention-days: 90

      - name: Upload SBOM to GitHub
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: sbom-release
          path: |
            sbom-cyclonedx.json
            dependency-digest.txt
          retention-days: 365

