# Copyright © 2026 Eser KUBALI <lxldev.contact@gmail.com>
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This file is part of LLMEngine and is licensed under
# the GNU General Public License v3.0 or later.
# See the LICENSE file in the project root for details.

name: Performance Benchmark

permissions:
  contents: read

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'CMakeLists.txt'
      - '.github/workflows/performance-benchmark.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - 'CMakeLists.txt'
      - '.github/workflows/performance-benchmark.yml'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  performance-benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake g++ make time python3 python3-pip libssl-dev
      
      - name: Install GNU time
        run: |
          sudo apt-get update
          sudo apt-get install -y time
      
      - name: Install meson
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install meson
          meson --version
      
      - name: Configure Release
        run: |
          cmake -S . -B build -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON

      - name: Build (make -j20)
        run: |
          cmake --build build -- -j20
          # Explicitly build test targets (they're EXCLUDE_FROM_ALL by default)
          cmake --build build --target build_all_tests -j20
      
      
      
      - name: Run performance benchmarks (ctest timing)
        run: |
          echo "=== Performance Benchmark Results ==="
          cd build
          /usr/bin/time -f "ctest: %e s, %M KB" ctest --output-on-failure || true
          cd ..
          if [ -f build/libLLMEngine.a ]; then
            echo "Library size: $(stat -c%s build/libLLMEngine.a) bytes"
          fi
          echo "Build configuration verification:"
          if [ -f build/CMakeCache.txt ]; then
            echo "- O3 occurrences: $(grep -c O3 build/CMakeCache.txt || echo 0)"
          else
            echo "- CMake cache not found"
          fi
      
      - name: Clean up
        run: |
          echo "Cleaning up temporary directories..."
          rm -rf /tmp/LLMEngine-bench-*
          echo "Cleanup completed"
      
      - name: Performance summary
        run: |
          echo "=== Performance Benchmark Summary ==="
          echo "✓ Performance build completed successfully"
          echo "✓ All benchmark tests passed"
          echo "✓ Performance metrics captured"
          echo ""
          echo "Note: Performance benchmarks help detect regressions."
          echo "Consider setting up performance tracking over time."