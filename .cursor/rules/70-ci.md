# CI/CD Rules

## Overview

This document defines CI/CD guidelines for LLMEngine. These rules ensure consistent, reliable builds, comprehensive testing, and code quality checks in continuous integration.

## GitHub Actions Workflow Structure

### Main CI Workflow (`.github/workflows/ci.yml`)

The primary CI workflow should include:

1. **Build and Test Matrix**: Multiple compiler/build configurations
2. **Lint Job**: Static analysis with clang-tidy
3. **Format Check**: Verify code formatting
4. **Coverage**: Generate and upload coverage reports

### Workflow Triggers

```yaml
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
```

## Build and Test Matrix

### Compiler Matrix

Test with multiple compilers and versions:

- **GCC**: Version 11, 12 (minimum supported)
- **Clang**: Version 14, 15 (minimum supported)
- **Build Types**: Debug and Release

```yaml
strategy:
  fail-fast: false
  matrix:
    include:
      - compiler: gcc
        compiler_version: "11"
        build_type: Debug
        sanitizers: true
      - compiler: gcc
        compiler_version: "12"
        build_type: Release
        sanitizers: false
      - compiler: clang
        compiler_version: "14"
        build_type: Debug
        sanitizers: true
      - compiler: clang
        compiler_version: "15"
        build_type: Release
        sanitizers: false
```

### Build Steps

1. **Checkout**: Check out source code
2. **Setup CMake**: Install CMake 3.20+
3. **Install Dependencies**: System packages (compiler, build tools)
4. **Configure**: CMake configuration with appropriate options
5. **Build**: Compile with parallel jobs (`-j20`)
6. **Test**: Run tests with CTest

```yaml
steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Setup CMake
    uses: jwlawson/actions-setup-cmake@v1
    with:
      cmake-version: "3.20"

  - name: Install dependencies
    run: |
      sudo apt-get update
      sudo apt-get install -y \
        ninja-build \
        build-essential \
        libssl-dev \
        ${{ matrix.compiler }}-${{ matrix.compiler_version }}

  - name: Configure
    run: |
      cmake -S . -B build \
        -G Ninja \
        -DCMAKE_C_COMPILER=$CC \
        -DCMAKE_CXX_COMPILER=$CXX \
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
        ${{ matrix.cmake_options }} \
        -DBUILD_TESTING=ON \
        -DWARNING_MODE=ON \
        -DWERROR=ON

  - name: Build
    run: cmake --build build -j20

  - name: Test
    run: |
      cd build
      ctest --output-on-failure -j20
```

## Sanitizers in Debug Builds

### Enable Sanitizers

Run sanitizers in Debug builds to catch memory errors and undefined behavior:

```yaml
cmake_options: "-DDEBUG_MODE=ON -DENABLE_SANITIZERS=ON -DWARNING_MODE=ON"
```

Sanitizers include:
- **AddressSanitizer (ASan)**: Memory errors
- **UndefinedBehaviorSanitizer (UBSan)**: Undefined behavior
- **ThreadSanitizer (TSan)**: Data races (optional)

## Coverage

### Generate Coverage Reports

Enable coverage in Debug builds:

```yaml
- name: Configure (with coverage)
  run: |
    cmake -S . -B build \
      -DCMAKE_BUILD_TYPE=Debug \
      -DENABLE_COVERAGE=ON \
      -DBUILD_TESTING=ON

- name: Build and Test
  run: |
    cmake --build build -j20
    cd build
    ctest --output-on-failure

- name: Generate Coverage
  run: |
    cd build
    # For GCC
    lcov --capture --directory . --output-file coverage.info
    lcov --remove coverage.info '/usr/*' --output-file coverage.info
    # For Clang
    llvm-cov export -format=lcov -instr-profile=default.profdata ./test/test_* > coverage.info

- name: Upload Coverage
  uses: codecov/codecov-action@v3
  with:
    file: ./build/coverage.info
    flags: unittests
    name: codecov-umbrella
```

### Coverage Goals

- **Minimum**: 80% line coverage
- **Target**: 90%+ for critical paths
- **Focus**: Public API, error paths, edge cases

## clang-tidy Job

### Separate Lint Job

Run clang-tidy in a separate job for parallel execution:

```yaml
lint:
  name: Code Quality Checks
  runs-on: ubuntu-latest
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          build-essential \
          clang-tidy

    - name: Configure with clang-tidy
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_CLANG_TIDY=ON \
          -DBUILD_TESTING=ON

    - name: Build (clang-tidy will run)
      run: cmake --build build -j20 || true

    - name: Check clang-tidy results
      run: |
        if cmake --build build 2>&1 | grep -i "error:"; then
          echo "clang-tidy found issues!"
          exit 1
        fi
```

### clang-tidy Configuration

- Enable via `ENABLE_CLANG_TIDY` CMake option
- Use `.clang-tidy` configuration file
- Treat warnings as errors in CI

## Format Check

### Verify Code Formatting

Add a format check job to ensure code is formatted:

```yaml
format-check:
  name: Format Check
  runs-on: ubuntu-latest
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check formatting
      run: |
        find src include test -name "*.cpp" -o -name "*.hpp" | \
          xargs clang-format --dry-run --Werror
```

## Caching

### Cache Dependencies

Cache CMake build artifacts and dependency downloads:

```yaml
- name: Cache CMake
  uses: actions/cache@v3
  with:
    path: |
      ~/.cache/ccache
      build
    key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}
    restore-keys: |
      ${{ runner.os }}-cmake-

- name: Cache dependencies
  uses: actions/cache@v3
  with:
    path: build/_deps
    key: ${{ runner.os }}-deps-${{ hashFiles('**/CMakeLists.txt') }}
    restore-keys: |
      ${{ runner.os }}-deps-
```

## Best Practices

### Workflow Organization

1. **Separate jobs**: Build/test, lint, format check
2. **Parallel execution**: Run independent jobs in parallel
3. **Fail fast**: Use `fail-fast: false` for matrix builds to see all failures
4. **Clear job names**: Descriptive names for each job

### Build Configuration

1. **Warnings as errors**: Enable `-DWERROR=ON` in CI
2. **Sanitizers**: Enable in Debug builds
3. **Coverage**: Generate in Debug builds
4. **Parallel builds**: Use `-j20` for faster builds

### Test Execution

1. **Output on failure**: Use `ctest --output-on-failure`
2. **Parallel tests**: Use `-j20` for parallel test execution
3. **Test isolation**: Tests should not depend on each other

### Error Handling

1. **Clear error messages**: Failures should be easy to diagnose
2. **Artifact upload**: Upload build logs on failure
3. **Status reporting**: Report status to PR/push

## Summary

1. **Build matrix**: Multiple compilers and build types
2. **Sanitizers**: Enable in Debug builds
3. **Coverage**: Generate and upload coverage reports
4. **clang-tidy**: Separate lint job
5. **Format check**: Verify code formatting
6. **Caching**: Cache build artifacts and dependencies
7. **Parallel execution**: Run jobs in parallel when possible

## References

- See `50-cmake.md` for CMake configuration
- See `60-tests.md` for test requirements
- See `80-formatting.md` for formatting rules
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

