rules:
  - id: cxx-strict-build-before-commit
    match: "(?i)\\bplan agent\\b"
    actions:
      - enforce: true
      - instruction: |
          For C and C++ projects, before staging or committing, first perform a non-interactive, warning-free build.

          Build policy:
          - Treat any compiler warnings or errors as a hard failure for the task.
          - If any warnings or errors are detected in build output, DO NOT COMMIT. Fix the issues and rerun the task.
          - Do not ask for confirmation; fail fast and proceed to repairs autonomously.

          Build steps (non-interactive, use the first that applies):
          1) If a Makefile exists in ./build, run:
             - cd build
             - make -j20
          2) Else if a Makefile exists in the repository root, run:
             - make -j20
          3) Else if it is a CMake project (CMakeLists.txt exists), run:
             - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
             - cd build
             - make -j20

          Warning detection criteria:
          - Consider any line containing "warning:" (case-insensitive) a failure.
          - Consider any line containing "error:" (case-insensitive) a failure.
          - If the toolchain supports it, prefer enabling flags that elevate warnings to errors (e.g., -Wall -Wextra -Wpedantic -Werror) via environment or generator options, but do not modify project files.

          Commit gating:
          - Only proceed to staging/commit if the last build completed successfully with ZERO warnings and ZERO errors.
          - If the working tree is dirty but the build fails or has warnings, do not stage or commit.
          - Do not amend, rebase, or push as part of this step.

          Logging and behavior:
          - Summarize any found warnings/errors and the first few offending lines for quick diagnosis.
          - Continue to the next subtask only after a passing, warning-free build.
          - Use non-interactive commands and do not change global Git configuration.

          Examples of acceptable outcomes before commit:
          - Build: success; Diagnostics: 0 errors, 0 warnings — proceed to commit.
          - Build: failed or warnings present — do not commit; attempt fixes and rebuild.
